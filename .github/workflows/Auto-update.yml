name: OpenClash Update Check

on:
  schedule:
    # 每天北京时间12点运行 (UTC+8 对应 UTC 4:00)
    - cron: '0 4 * * *'
  workflow_dispatch: # 允许手动运行

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Check if openclash.ipk exists
      id: check_file
      run: |
        if [ -f "gxjc/openclash.ipk" ]; then
          echo "file_exists=true" >> $GITHUB_OUTPUT
          echo "OpenClash IPK file found, continuing..."
        else
          echo "file_exists=false" >> $GITHUB_OUTPUT
          echo "❌ OpenClash IPK file not found in gxjc folder"
          exit 1
        fi

    - name: Calculate local file hashes
      id: local_hash
      if: steps.check_file.outputs.file_exists == 'true'
      run: |
        cd gxjc
        echo "Calculating hashes for local openclash.ipk..."
        
        # 计算多种哈希值
        SHA256_HASH=$(sha256sum openclash.ipk | cut -d' ' -f1)
        SHA1_HASH=$(sha1sum openclash.ipk | cut -d' ' -f1)
        MD5_HASH=$(md5sum openclash.ipk | cut -d' ' -f1)
        
        echo "local_sha256=$SHA256_HASH" >> $GITHUB_OUTPUT
        echo "local_sha1=$SHA1_HASH" >> $GITHUB_OUTPUT
        echo "local_md5=$MD5_HASH" >> $GITHUB_OUTPUT
        
        echo "Local file hashes:"
        echo "SHA256: $SHA256_HASH"
        echo "SHA1: $SHA1_HASH"
        echo "MD5: $MD5_HASH"

    - name: Get latest OpenClash version info
      id: get_version
      if: steps.check_file.outputs.file_exists == 'true'
      run: |
        # 获取目录列表并解析最新的openclash包
        echo "Fetching available OpenClash packages..."
        PACKAGE_LIST=$(curl -s "https://downloads.immortalwrt.org/releases/24.10.4/packages/aarch64_cortex-a53/luci/" | \
          grep -o 'href="luci-app-openclash[^"]*\.ipk"' | \
          sed 's/href="//' | sed 's/"//' | sort -V | tail -1)
        
        if [ -z "$PACKAGE_LIST" ]; then
          echo "❌ No OpenClash packages found"
          exit 1
        fi
        
        LATEST_PACKAGE=$PACKAGE_LIST
        echo "latest_package=$LATEST_PACKAGE" >> $GITHUB_OUTPUT
        echo "Latest package: $LATEST_PACKAGE"

    - name: Download latest OpenClash package
      id: download_package
      if: steps.check_file.outputs.file_exists == 'true'
      run: |
        PACKAGE_URL="https://downloads.immortalwrt.org/releases/24.10.4/packages/aarch64_cortex-a53/luci/${{ steps.get_version.outputs.latest_package }}"
        echo "Downloading: $PACKAGE_URL"
        
        # 下载文件
        wget -O latest_openclash.ipk "$PACKAGE_URL"
        
        if [ ! -f "latest_openclash.ipk" ]; then
          echo "❌ Failed to download package"
          exit 1
        fi
        
        # 计算下载文件的哈希值
        REMOTE_SHA256=$(sha256sum latest_openclash.ipk | cut -d' ' -f1)
        REMOTE_SHA1=$(sha1sum latest_openclash.ipk | cut -d' ' -f1)
        REMOTE_MD5=$(md5sum latest_openclash.ipk | cut -d' ' -f1)
        
        echo "remote_sha256=$REMOTE_SHA256" >> $GITHUB_OUTPUT
        echo "remote_sha1=$REMOTE_SHA1" >> $GITHUB_OUTPUT
        echo "remote_md5=$REMOTE_MD5" >> $GITHUB_OUTPUT
        
        echo "Remote file hashes:"
        echo "SHA256: $REMOTE_SHA256"
        echo "SHA1: $REMOTE_SHA1"
        echo "MD5: $REMOTE_MD5"

    - name: Compare hashes and update if different
      id: compare_update
      if: steps.check_file.outputs.file_exists == 'true'
      run: |
        echo "Comparing hashes..."
        
        # 比较哈希值（任一匹配即可）
        if [ "${{ steps.local_hash.outputs.local_sha256 }}" == "${{ steps.download_package.outputs.remote_sha256 }}" ] || \
           [ "${{ steps.local_hash.outputs.local_sha1 }}" == "${{ steps.download_package.outputs.remote_sha1 }}" ] || \
           [ "${{ steps.local_hash.outputs.local_md5 }}" == "${{ steps.download_package.outputs.remote_md5 }}" ]; then
          echo "Hashes match - no update needed"
          echo "update_needed=false" >> $GITHUB_OUTPUT
        else
          echo "Hashes differ - update required"
          echo "update_needed=true" >> $GITHUB_OUTPUT
          
          # 替换本地文件
          mv latest_openclash.ipk gxjc/openclash.ipk
          echo "✅ Local file updated"
        fi

    - name: Commit and push changes
      if: steps.compare_update.outputs.update_needed == 'true'
      run: |
        # 配置git用户信息
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # 提交更改
        git add gxjc/openclash.ipk
        git commit -m "chore: update OpenClash package to latest version
        
        Updated OpenClash IPK file:
        - Package: ${{ steps.get_version.outputs.latest_package }}
        - SHA256: ${{ steps.download_package.outputs.remote_sha256 }}
        - SHA1: ${{ steps.download_package.outputs.remote_sha1 }}
        - MD5: ${{ steps.download_package.outputs.remote_md5 }}"
        
        # 推送更改
        git push

    - name: Trigger other workflows
      if: steps.compare_update.outputs.update_needed == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Triggering other workflows..."
        
        # 获取仓库信息
        REPO=${{ github.repository }}
        
        # 使用gh命令触发其他工作流
        # 这里需要根据您具体的workflow文件名来调整
        gh workflow list
        echo "Use the above workflow list to trigger specific workflows"
        
        # 示例：触发所有工作流（谨慎使用）
        # gh workflow run --repo $REPO --ref ${{ github.ref }} ALL_WORKFLOWS
        
        # 或者触发特定工作流，例如：
        # gh workflow run "build.yml" --repo $REPO
        # gh workflow run "deploy.yml" --repo $REPO
        
        gh workflow run "Build-immortalwrt.yml" --repo $REPO

        echo "Please configure specific workflow triggers as needed"

    - name: Clean up
      if: always()
      run: |
        # 清理临时文件
        if [ -f "latest_openclash.ipk" ]; then
          rm -f latest_openclash.ipk
        fi
