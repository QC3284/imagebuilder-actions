name: ğŸ”§ ImmortalWrt AutoBuilder

on:
#  schedule:
#    - cron: '0 2 * * *'   # åŒ—äº¬æ—¶é—´10:00 (UTC 2:00)
#    - cron: '0 10 * * *'  # åŒ—äº¬æ—¶é—´18:00 (UTC 10:00)
  workflow_dispatch:
  push:
    paths:
      - 'config/*'
      - 'zdy_pkg/*'
      - 'zdy_fk_pkg/*'

jobs:
  config:
    name: âš™ï¸ Load Configuration
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: ğŸ›¬ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ” Validate Config Files
      run: |
        if [ ! -f "config/devices.json" ] || [ ! -f "config/version.json" ]; then
          echo "::error::Missing config files!"
          exit 1
        fi
        echo "Config files validation passed âœ…"

    - name: ğŸ“‹ Read Configuration
      id: set-matrix
      run: |
        if jq -e '.devices' config/devices.json >/dev/null 2>&1; then
          DEVICES=$(jq -r '.devices[]' config/devices.json)
        else
          DEVICES=$(jq -r '.[]' config/devices.json)
        fi

        VERSION=$(jq -r '.version' config/version.json)

        MATRIX_JSON=$(jq -n -c \
          --argjson devices "$(jq -n -c --arg in "$DEVICES" '$in | split("\n") | map(select(. != ""))')" \
          --arg version "$VERSION" \
          '{
            include: $devices | map({
              device: .,
              version: $version
            })
          }')

        echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
        echo "::notice::Build matrix generated for $VERSION: $MATRIX_JSON"

  build-firmware:
    name: ğŸ”¨ Build ${{ matrix.device }}
    needs: config
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.config.outputs.matrix) }}
      fail-fast: false

    steps:
    - name: ğŸ›¬ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ“… Get Build Date (CST)
      id: get-date
      run: |
        TZ='Asia/Shanghai'
        build_date=$(TZ=$TZ date +'%Y-%m-%d %H:%M:%S %Z')
        formatted_date=$(TZ=$TZ date +'%Y%m%d%H%M%S')
        echo "date=$build_date" >> $GITHUB_OUTPUT
        echo "formatted_date=$formatted_date" >> $GITHUB_OUTPUT
        echo "timestamp=$(TZ=$TZ date +%s)" >> $GITHUB_OUTPUT
        echo "::notice::Build date: $formatted_date"

    - name: ğŸ”§ Setup Build Environment
      run: |
        sudo apt-get update -y
        sudo apt-get install -y build-essential libncurses5-dev zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip python3 jq zstd axel coreutils openssl rhash
        sudo apt-get install -y libncursesw5-dev zlib1g-dev genisoimage xsltproc rsync wget unzip dnsmasq stunnel4 net-tools resolvconf python3 python3-pip python3-venv iptables-persistent net-tools

    - name: ğŸ—ºï¸ Determine Target Architecture
      id: target
      run: |
        DEVICE="${{ matrix.device }}"

        declare -A DEVICE_TARGETS=(
          ["glinet_gl-mt3000"]="mediatek/filogic"
          ["glinet_gl-mt2500"]="mediatek/filogic"
          ["glinet_gl-mt6000"]="mediatek/filogic"
          ["konka_komi-a31"]="mediatek/filogic"
          ["xiaomi_redmi-router-ax6000"]="mediatek/filogic"
          ["xiaomi_mi-router-3g"]="ramips/mt7621"
          ["xiaomi_mi-router-cr6606"]="ramips/mt7621"
          ["xiaomi_mi-router-cr6608"]="ramips/mt7621"
          ["xiaomi_mi-router-cr6609"]="ramips/mt7621"
          ["netgear_r7800"]="ipq806x/generic"
          ["linksys_wrt3200acm"]="mvebu/cortexa9"
          ["tplink_archer-c7-v5"]="ath79/generic"
        )

        if [[ -n "${DEVICE_TARGETS[$DEVICE]}" ]]; then
          TARGET="${DEVICE_TARGETS[$DEVICE]}"
        else
          echo "::error::Unknown device type: $DEVICE"
          exit 1
        fi

        echo "target=$TARGET" >> $GITHUB_OUTPUT
        echo "sanitized_target=${TARGET//\//-}" >> $GITHUB_OUTPUT
        echo "::notice::Target for $DEVICE: $TARGET"

    - name: â¬‡ï¸ Download ImageBuilder (with axel)
      id: download
      run: |
        SANITIZED_TARGET="${{ steps.target.outputs.sanitized_target }}"
        VERSION="${{ matrix.version }}"

        # ä½¿ç”¨å®˜æ–¹ä¸‹è½½æº
        BASE_URL="https://immortalwrt.kyarucloud.moe/releases/$VERSION/targets/${{ steps.target.outputs.target }}"

        URLS=(
          "$BASE_URL/immortalwrt-imagebuilder-$VERSION-$SANITIZED_TARGET.Linux-x86_64.tar.zst"
          "$BASE_URL/immortalwrt-imagebuilder-$SANITIZED_TARGET.Linux-x86_64.tar.zst"
          "$BASE_URL/immortalwrt-imagebuilder-$VERSION-$SANITIZED_TARGET.Linux-x86_64.tar.xz"
          "$BASE_URL/immortalwrt-imagebuilder-$SANITIZED_TARGET.Linux-x86_64.tar.xz"
        )

        FOUND=0
        for URL in "${URLS[@]}"; do
          echo "ğŸ” Checking: $URL"
          if wget -q --spider "$URL"; then
            echo "âœ… Found valid ImageBuilder at: $URL"
            # ä½¿ç”¨axelåŠ é€Ÿä¸‹è½½ï¼ˆ64çº¿ç¨‹ï¼‰
            echo "ğŸš€ Downloading with axel (64 threads)..."
            axel -n 64 -o imagebuilder.tar.zst "$URL"

            # æ£€æŸ¥axelä¸‹è½½æ˜¯å¦æˆåŠŸä¸”æ–‡ä»¶å®Œæ•´
            if [ $? -eq 0 ] && [ -f "imagebuilder.tar.zst" ] && [ $(stat -c%s "imagebuilder.tar.zst") -gt 1000000 ]; then
              echo "âœ… Axel download completed and file size seems valid"
              FOUND=1
              break
            else
              echo "âš ï¸ Axel download may have failed or file is too small, checking file..."
              if [ -f "imagebuilder.tar.zst" ]; then
                echo "ğŸ“Š File size: $(stat -c%s "imagebuilder.tar.zst") bytes"
              fi
              echo "ğŸ”„ Trying with wget as fallback..."
              wget -O imagebuilder.tar.zst "$URL" && {
                if [ -f "imagebuilder.tar.zst" ] && [ $(stat -c%s "imagebuilder.tar.zst") -gt 1000000 ]; then
                  echo "âœ… Wget download completed successfully"
                  FOUND=1
                  break
                else
                  echo "âš ï¸ Wget download also failed or file too small"
                fi
              }
            fi
          fi
        done

        if [ "$FOUND" -eq 0 ]; then
          echo "::error::ImageBuilder not found or download failed at any URL"
          for URL in "${URLS[@]}"; do
            echo "::error::Tried: $URL"
          done
          exit 1
        fi

    - name: ğŸ“¦ Extract ImageBuilder
      run: |
        echo "ğŸ” Checking downloaded file..."
        if [ ! -f "imagebuilder.tar.zst" ]; then
          echo "::error::ImageBuilder archive not found!"
          exit 1
        fi

        FILESIZE=$(stat -c%s "imagebuilder.tar.zst")
        echo "ğŸ“Š Archive size: $FILESIZE bytes"

        if [ "$FILESIZE" -lt 1000000 ]; then
          echo "::error::Archive file is too small (å¯èƒ½ä¸‹è½½ä¸­æ–­)"
          exit 1
        fi

        if file imagebuilder.tar.zst | grep -q "Zstandard"; then
          echo "ğŸ”§ Extracting Zstandard archive"
          tar -I zstd -xf imagebuilder.tar.zst
        elif file imagebuilder.tar.zst | grep -q "XZ"; then
          echo "ğŸ”§ Extracting XZ archive"
          tar -xJf imagebuilder.tar.zst
        elif file imagebuilder.tar.zst | grep -q "gzip"; then
          echo "ğŸ”§ Extracting gzip archive"
          tar -xzf imagebuilder.tar.zst
        else
          echo "âš ï¸ Unknown archive format, trying general extraction..."
          tar -xf imagebuilder.tar.zst || {
            echo "::error::Failed to extract archive"
            exit 1
          }
        fi

        mv immortalwrt-imagebuilder-* imagebuilder
        echo "âœ… ImageBuilder extracted successfully"

    # ===== æ–°å¢çš„è‡ªå®šä¹‰è½¯ä»¶åŒ…å¤åˆ¶æ­¥éª¤ =====
    - name: ğŸ“¥ Copy Custom Packages
      id: custom-pkgs
      run: |
        echo "ğŸ” Checking for custom package configuration..."
        PKG_DIR="$GITHUB_WORKSPACE/imagebuilder/packages"
        mkdir -p "$PKG_DIR"

        # æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨è‡ªå®šä¹‰åˆ—è¡¨ä¸­
        check_device_in_list() {
          local list_file="$1"
          if [ -f "$list_file" ]; then
            if grep -qE "^\s*${{ matrix.device }}\s*$" "$list_file"; then
              echo "âœ… Device ${{ matrix.device }} found in $list_file"
              return 0
            else
              echo "â„¹ï¸ Device ${{ matrix.device }} NOT found in $list_file"
            fi
          else
            echo "â„¹ï¸ $list_file not found"
          fi
          return 1
        }

        # å¤„ç†ä¸»è‡ªå®šä¹‰åŒ…
        if check_device_in_list "zdy_rjb.txt"; then
          if [ -d "zdy_pkg" ]; then
            echo "ğŸ“¦ Copying custom packages from zdy_pkg to $PKG_DIR"
            find zdy_pkg -name '*.ipk' -exec cp -v {} "$PKG_DIR" \;
          else
            echo "âš ï¸ zdy_pkg directory not found"
          fi
        fi

        # å¤„ç†åˆ†æ§è‡ªå®šä¹‰åŒ…
        if check_device_in_list "zdy_rjb_fk.txt"; then
          if [ -d "zdy_fk_pkg" ]; then
            echo "ğŸ“¦ Copying custom packages from zdy_fk_pkg to $PKG_DIR"
            find zdy_fk_pkg -name '*.ipk' -exec cp -v {} "$PKG_DIR" \;
          else
            echo "âš ï¸ zdy_fk_pkg directory not found"
          fi
        fi

        # åˆ—å‡ºå¤åˆ¶çš„åŒ…
        echo "ğŸ“¦ Copied packages:"
        ls -lh "$PKG_DIR" || true

        # è®¾ç½®è¾“å‡ºå˜é‡ç”¨äºåç»­æ­¥éª¤
        if [ -n "$(ls -A "$PKG_DIR")" ]; then
          echo "::notice::Custom packages added to build"
          echo "has_custom_pkgs=true" >> $GITHUB_OUTPUT
        else
          echo "::notice::No custom packages added"
          echo "has_custom_pkgs=false" >> $GITHUB_OUTPUT
        fi
    # ===== æ–°å¢æ­¥éª¤ç»“æŸ =====

    - name: ğŸ“¦ Prepare Packages
      id: packages
      run: |
        CUSTOM_PKG_FILE="config/packages_${{ matrix.device }}.txt"
        DEFAULT_PKG_FILE="config/default_packages.txt"

        if [ -f "$CUSTOM_PKG_FILE" ]; then
          echo "::notice::Using custom packages for ${{ matrix.device}}"
          # è¿‡æ»¤æ‰ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
          PACKAGES=$(grep -vE '^#|^$' "$CUSTOM_PKG_FILE" | tr '\n' ' ')
        elif [ -f "$DEFAULT_PKG_FILE" ]; then
          echo "::notice::Using default packages"
          PACKAGES=$(grep -vE '^#|^$' "$DEFAULT_PKG_FILE" | tr '\n' ' ')
        else
          echo "::error::No package list found!"
          exit 1
        fi

        # æ·»åŠ å¿…è¦çš„åŸºç¡€åŒ…
        BASE_PKGS="luci luci-theme-bootstrap -dnsmasq dnsmasq-full"
        FULL_PKGS="$BASE_PKGS $PACKAGES"

        echo "ğŸ“¦ Packages to install: $FULL_PKGS"
        echo "PACKAGES=$FULL_PKGS" >> $GITHUB_ENV

    - name: ğŸ”¨ Build Firmware
      run: |
        cd imagebuilder
        echo "ğŸš€ Building firmware for ${{ matrix.device }} with packages: $PACKAGES"

        # è·å–CPUæ ¸å¿ƒæ•°ï¼Œé™åˆ¶æœ€å¤§å¹¶è¡Œæ•°
        NPROC=$(nproc)
        MAX_JOBS=$(( NPROC > 4 ? 4 : NPROC ))

        echo "ğŸ”„ Using $MAX_JOBS parallel jobs for downloading"

        if ! make -j$MAX_JOBS image PROFILE="${{ matrix.device }}" PACKAGES="$PACKAGES" FILES="../files/" V=s; then
          echo "::error::Build failed for ${{ matrix.device }}"

          # æ”¶é›†é”™è¯¯æ—¥å¿—
          if [ -d "logs" ]; then
            ERRORS=$(grep -i 'error\|failed\|undefined' logs/*.log | head -n 20 || true)
          else
            ERRORS="No logs directory found"
          fi

          echo "::error::Build errors:"
          echo "$ERRORS"

          exit 1
        fi

        echo "âœ… Build completed successfully in parallel mode"

    - name: ğŸ”„ Rename Firmware Files
      id: rename-firmware
      run: |
        cd imagebuilder/bin/targets

        # è·å–æ ¼å¼åŒ–æ—¥æœŸ
        FORMATTED_DATE="${{ steps.get-date.outputs.formatted_date }}"
        echo "ğŸ“… Using formatted date for renaming: $FORMATTED_DATE"

        # æŸ¥æ‰¾æ‰€æœ‰å›ºä»¶æ–‡ä»¶
        find . -type f \( -name "*.bin" -o -name "*.img" -o -name "*.itb" -o -name "*.fip" -o -name "*.gz" -o -name "*.trx" \) | while read -r file; do
          # è·å–æ–‡ä»¶æ‰€åœ¨ç›®å½•å’Œæ–‡ä»¶å
          dir=$(dirname "$file")
          filename=$(basename "$file")

          echo "ğŸ“„ Original filename: $filename"

          # åˆ†ææ–‡ä»¶åç»“æ„å¹¶æ’å…¥æ—¥æœŸ
          # åŸå§‹æ ¼å¼: immortalwrt-24.10.4-mediatek-filogic-glinet_gl-mt3000-squashfs-sysupgrade.bin
          # æ–°æ ¼å¼: immortalwrt-24.10.4-20250117204610-mediatek-filogic-glinet_gl-mt3000-squashfs-sysupgrade.bin

          if [[ "$filename" =~ ^(immortalwrt-[0-9]+\.[0-9]+\.[0-9]+)-([a-zA-Z0-9_-]+)$ ]]; then
            # åŒ¹é…ç±»ä¼¼: immortalwrt-24.10.4-mediatek-filogic-glinet_gl-mt3000-squashfs-sysupgrade.bin
            prefix="${BASH_REMATCH[1]}"
            suffix="${BASH_REMATCH[2]}"
            new_filename="${prefix}-${FORMATTED_DATE}-${suffix}"
          elif [[ "$filename" =~ ^(immortalwrt-[0-9]+\.[0-9]+\.[0-9]+-)[a-zA-Z0-9_-]+\.(bin|img|itb|fip|gz|trx)$ ]]; then
            # åŒ¹é…å…¶ä»–æ ¼å¼ï¼Œç›´æ¥æ’å…¥æ—¥æœŸ
            base_name="${filename%.*}"
            extension="${filename##*.}"
            new_filename="${base_name}-${FORMATTED_DATE}.${extension}"
          else
            # å¦‚æœæ— æ³•åŒ¹é…æ¨¡å¼ï¼Œæ·»åŠ æ—¥æœŸåç¼€
            base_name="${filename%.*}"
            extension="${filename##*.}"
            new_filename="${base_name}-${FORMATTED_DATE}.${extension}"
          fi

          # é‡å‘½åæ–‡ä»¶
          echo "ğŸ”„ Renaming: $filename -> $new_filename"
          mv "$file" "$dir/$new_filename"
        done

        echo "âœ… Firmware files renamed with date: $FORMATTED_DATE"

    - name: ğŸ”¢ Calculate Hashes
      id: calculate-hashes
      run: |
        cd imagebuilder/bin/targets

        # åˆ›å»ºSHA256æ‘˜è¦æ–‡ä»¶
        SHA256_FILE="sha256sums.txt"
        > "$SHA256_FILE"

        # æŸ¥æ‰¾æ‰€æœ‰å›ºä»¶æ–‡ä»¶
        find . -type f \( -name "*.bin" -o -name "*.img" -o -name "*.itb" -o -name "*.fip" -o -name "*.gz" -o -name "*.trx" \) | while read -r file; do
          echo "ğŸ“„ Calculating hashes for: $file"

          # è·å–æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰
          filename=$(basename "$file")

          # è®¡ç®—å„ç§å“ˆå¸Œå€¼
          SHA256=$(sha256sum "$file" | awk '{print $1}')
          SHA512=$(sha512sum "$file" | awk '{print $1}')
          MD5=$(md5sum "$file" | awk '{print $1}')

          # ä¿å­˜åˆ°SHA256æ‘˜è¦æ–‡ä»¶
          echo "$SHA256  $filename" >> "$SHA256_FILE"

          # åˆ›å»ºè¯¦ç»†çš„å“ˆå¸Œæ–‡ä»¶
          echo "ğŸ” SHA256: $SHA256" > "$file.hashes"
          echo "ğŸ” SHA512: $SHA512" >> "$file.hashes"
          echo "ğŸ” MD5: $MD5" >> "$file.hashes"

          # å¯é€‰çš„å…¶ä»–å“ˆå¸Œ
          echo "ğŸ” BLAKE2: $(b2sum "$file" | awk '{print $1}')" >> "$file.hashes"
          echo "ğŸ” SHA1: $(sha1sum "$file" | awk '{print $1}')" >> "$file.hashes"

          # å›½å¯† SM3 (å¦‚æœå¯ç”¨)
          if openssl list -digest-commands | grep -q sm3; then
            echo "ğŸ” SM3: $(openssl sm3 -r "$file" | awk '{print $1}')" >> "$file.hashes"
          fi

          echo "ğŸ“ Hashes saved to $file.hashes"
        done

        # è¾“å‡ºSHA256æ‘˜è¦
        echo "ğŸ“‹ SHA256 Digests:"
        cat "$SHA256_FILE"

        # å°†SHA256æ‘˜è¦ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ä¾›å‘å¸ƒæ­¥éª¤ä½¿ç”¨
        SHA256_CONTENT=$(cat "$SHA256_FILE")
        echo "sha256_content<<EOF" >> $GITHUB_OUTPUT
        echo "$SHA256_CONTENT" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ğŸ—œï¸ Archive Artifacts
      run: |
        # ç¡®ä¿åœ¨æ­£ç¡®çš„å·¥ä½œç›®å½•
        cd "$GITHUB_WORKSPACE"

        # åˆ›å»ºè®¾å¤‡ç›®å½•
        mkdir -p artifacts/${{ matrix.device }}

        # ä½¿ç”¨ç»å¯¹è·¯å¾„æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶å’Œå“ˆå¸Œæ–‡ä»¶
        echo "ğŸ” Searching for firmware files in imagebuilder/bin/targets..."
        FIRMWARE_FILES=$(find imagebuilder/bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" -o -name "*.trx" -o -name "*.itb" -o -name "*.fip" -o -name "*.hashes" -o -name "sha256sums.txt" \) 2>/dev/null)

        if [ -n "$FIRMWARE_FILES" ]; then
          echo "âœ… Found files:"
          echo "$FIRMWARE_FILES"

          # å¤åˆ¶æ–‡ä»¶
          echo "$FIRMWARE_FILES" | while read -r file; do
            echo "ğŸ“¦ Copying: $file"
            cp "$file" artifacts/${{ matrix.device }}/
          done
        else
          echo "::error::No firmware files found!"
          echo "::error::Build output directory content:"
          find imagebuilder/bin -type d -ls || true
          exit 1
        fi

        # æ£€æŸ¥æ˜¯å¦å¤åˆ¶äº†æ–‡ä»¶
        if [ -z "$(ls -A artifacts/${{ matrix.device }})" ]; then
          echo "::error::No files copied to artifacts directory!"
          echo "::error::Artifacts directory content:"
          ls -la artifacts/${{ matrix.device }}
          exit 1
        else
          echo "âœ… Copied $(ls artifacts/${{ matrix.device }} | wc -l) files to artifacts/${{ matrix.device }}"
        fi

        echo "DEVICE=${{ matrix.device }}" >> $GITHUB_ENV
        echo "ARTIFACT_DIR=artifacts/${{ matrix.device }}" >> $GITHUB_ENV

    - name: ğŸš€ Upload Release
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.ARTIFACT_DIR }}/*
        tag_name: build-${{ github.run_id }}-${{ matrix.device }}
        name: "Build ${{ github.run_number }} (${{ matrix.device }})"
        body: |
          ### ğŸš€ ImmortalWrt Firmware Build

          **Device**: `${{ matrix.device }}`
          **Version**: `${{ matrix.version }}`
          **Build ID**: `${{ github.run_id }}`
          **Build Date (CST)**: `${{ steps.get-date.outputs.date }}`
          **Date Tag**: `${{ steps.get-date.outputs.formatted_date }}`

          ### ğŸ“¦ Files Included:
          - Firmware files with date tag: `${{ steps.get-date.outputs.formatted_date }}`
          - SHA256 hash verification file: `sha256sums.txt`
          - Detailed hash files (`.hashes`) for each firmware

          ### ğŸ” SHA256 Checksums:
          ```
          ${{ steps.calculate-hashes.outputs.sha256_content }}
          ```

          ### ğŸ“ Other Hash Algorithms:
          Each firmware file has a corresponding `.hashes` file containing:
          - SHA512
          - MD5
          - BLAKE2
          - SHA1
          - SM3 (å›½å¯†ï¼Œå¦‚æœå¯ç”¨)

          Download the `.hashes` files for complete verification.

          ---
          ğŸ”§ Built with GitHub Actions at `${{ steps.get-date.outputs.date }}` (CST)

          ğŸ“… Date format in filenames: `${{ steps.get-date.outputs.formatted_date }}` (YYYYMMDDHHMMSS)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
