name: ğŸ› ï¸ ImmortalWrt Firmware Builder

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCåˆå¤œè‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:     # æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'ğŸ”– ImmortalWrtç‰ˆæœ¬ (é»˜è®¤: openwrt-24.10.1)'
        required: false
        default: 'openwrt-24.10.1'
      profile:
        description: 'ğŸ“± è®¾å¤‡å‹å· (ç•™ç©ºåˆ™ä½¿ç”¨é…ç½®æ–‡ä»¶)'
        required: false
      packages_file:
        description: 'ğŸ“¦ è‡ªå®šä¹‰è½¯ä»¶åŒ…æ–‡ä»¶è·¯å¾„ (ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤)'
        required: false

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # è¶…æ—¶è®¾ç½®

    steps:
    - name: 'ğŸš€ æ£€å‡ºä»“åº“'
      uses: actions/checkout@v4

    - name: 'ğŸ“¥ è§£æè®¾å¤‡é…ç½®'
      id: device-config
      run: |
        # ä»é…ç½®æ–‡ä»¶è¯»å–è®¾å¤‡åˆ—è¡¨
        DEVICES=$(cat devices.txt | tr '\n' ' ')
        echo "devices=${DEVICES}" >> $GITHUB_OUTPUT
        echo "â„¹ï¸ å·²åŠ è½½è®¾å¤‡åˆ—è¡¨: ${DEVICES}"

    - name: 'ğŸ”§ è®¾ç½®æ„å»ºå‚æ•°'
      id: setup
      run: |
        # ç¡®å®šè®¾å¤‡å‹å·
        if [ -n "${{ inputs.profile }}" ]; then
          PROFILE="${{ inputs.profile }}"
          echo "â„¹ï¸ ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šè®¾å¤‡: ${PROFILE}"
        else
          PROFILE="${{ steps.device-config.outputs.devices }}"
          echo "â„¹ï¸ ä½¿ç”¨é…ç½®æ–‡ä»¶è®¾å¤‡: ${PROFILE}"
        fi

        # ç¡®å®šè½¯ä»¶åŒ…æ–‡ä»¶
        if [ -n "${{ inputs.packages_file }}" ]; then
          PACKAGES_FILE="${{ inputs.packages_file }}"
          echo "â„¹ï¸ ä½¿ç”¨è‡ªå®šä¹‰è½¯ä»¶åŒ…æ–‡ä»¶: ${PACKAGES_FILE}"
        else
          PACKAGES_FILE="default_packages.txt"
          echo "â„¹ï¸ ä½¿ç”¨é»˜è®¤è½¯ä»¶åŒ…æ–‡ä»¶"
        fi

        # è®¾ç½®è¾“å‡ºå‚æ•°
        echo "profile=${PROFILE}" >> $GITHUB_OUTPUT
        echo "packages_file=${PACKAGES_FILE}" >> $GITHUB_OUTPUT
        echo "version=${{ inputs.version || 'openwrt-24.10.1' }}" >> $GITHUB_OUTPUT

    - name: 'ğŸ—ï¸ å®‰è£…ä¾èµ–'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev libncursesw5-dev \
          zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3

    - name: 'ğŸ“¦ è·å–ImageBuilder'
      run: |
        VERSION="${{ steps.setup.outputs.version }}"
        IB_URL="https://downloads.immortalwrt.org/releases/$VERSION/targets/$(echo ${{ steps.setup.outputs.profile }} | cut -d'_' -f1)/$(echo ${{ steps.setup.outputs.profile }} | cut -d'_' -f2)/immortalwrt-imagebuilder-$VERSION-$(echo ${{ steps.setup.outputs.profile }} | tr '_' '-').Linux-x86_64.tar.xz"
        
        echo "ğŸ“¥ ä¸‹è½½åœ°å€: ${IB_URL}"
        wget ${IB_URL}
        tar -xvf ./*.tar.xz
        rm ./*.tar.xz
        mv immortalwrt-imagebuilder-* imagebuilder
        echo "âœ… ImageBuilderå·²å‡†å¤‡å°±ç»ª"

    - name: 'ğŸ§© é…ç½®è½¯ä»¶åŒ…'
      run: |
        cd imagebuilder
        # ä»æ–‡ä»¶è¯»å–è½¯ä»¶åŒ…åˆ—è¡¨
        PACKAGES_LIST=$(cat ../${{ steps.setup.outputs.packages_file }} | tr '\n' ' ')
        echo "ğŸ“¦ è½¯ä»¶åŒ…åˆ—è¡¨: ${PACKAGES_LIST}"
        echo "PACKAGES_LIST=${PACKAGES_LIST}" >> $GITHUB_ENV

    - name: 'ğŸ”¨ æ„å»ºå›ºä»¶'
      run: |
        cd imagebuilder
        for DEVICE in ${{ steps.setup.outputs.profile }}; do
          echo "ğŸš§ æ­£åœ¨æ„å»ºè®¾å¤‡: $DEVICE"
          make image PROFILE="$DEVICE" PACKAGES="$PACKAGES_LIST"
          echo "âœ… $DEVICE æ„å»ºå®Œæˆ"
        done

    - name: 'ğŸ“¤ å‡†å¤‡å‘å¸ƒæ–‡ä»¶'
      run: |
        mkdir -p artifacts
        find imagebuilder/bin/targets -type f \( -name "*.bin" -o -name "*.img" \) -exec cp {} artifacts \;
        echo "ğŸ“¦ å›ºä»¶æ–‡ä»¶:" && ls -lh artifacts

    - name: 'ğŸš€ åˆ›å»ºRelease'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: firmware-${{ github.run_id }}
        name: "ğŸ‰ ${{ steps.setup.outputs.version }} å›ºä»¶ #${{ github.run_number }}"
        body: |
          ### ğŸ“… æ„å»ºä¿¡æ¯  
          **ç‰ˆæœ¬**: ${{ steps.setup.outputs.version }}  
          **è®¾å¤‡**: ${{ steps.setup.outputs.profile }}  
          **åŒ…å«è½¯ä»¶åŒ…**: [æŸ¥çœ‹åˆ—è¡¨](${{ github.server_url }}/${{ github.repository }}/blob/${{ github.sha }}/${{ steps.setup.outputs.packages_file }})  
          **æ„å»ºæ—¶é—´**: ${{ steps.prepare.outputs.timestamp }} UTC
        files: artifacts/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 'ğŸ§¹ æ¸…ç†å·¥ä½œåŒº'
      if: always()
      run: rm -rf imagebuilder artifacts
