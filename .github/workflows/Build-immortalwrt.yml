name: ğŸ”§ ImmortalWrt AutoBuilder

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCåˆå¤œè‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨

jobs:
  config:
    name: âš™ï¸ Load Configuration
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: ğŸ›¬ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ” Read Configuration
      id: set-matrix
      run: |
        # è¯»å–é…ç½®æ–‡ä»¶
        DEVICES=$(jq -r '.devices[]' config/devices.json)
        VERSION=$(jq -r '.version' config/version.json)
        
        # ç”Ÿæˆæ„å»ºçŸ©é˜µ
        MATRIX=$(jq -n '{include: []}')
        for DEVICE in $DEVICES; do
          MATRIX=$(echo $MATRIX | jq \
            --arg device "$DEVICE" \
            --arg version "$VERSION" \
            '.include += [{
              device: $device,
              version: $version
            }]')
        done
        
        # è®¾ç½®çŸ©é˜µè¾“å‡º
        echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
        echo "::notice::Build matrix generated: $MATRIX"

  build-firmware:
    name: ğŸ”¨ Build ${{ matrix.device }}
    needs: config
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.config.outputs.matrix) }}
      fail-fast: false  # ä¸€ä¸ªè®¾å¤‡å¤±è´¥ä¸å½±å“å…¶ä»–è®¾å¤‡

    steps:
    - name: ğŸ›¬ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ“… Get Build Date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: ğŸ”§ Setup Build Environment
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential libncurses5-dev zlib1g-dev \
          gawk git gettext libssl-dev xsltproc wget unzip python3 jq

    - name: ğŸ—ºï¸ Determine Target Architecture
      id: target
      run: |
        # ä»è®¾å¤‡åç§°æ¨æ–­ç›®æ ‡æ¶æ„
        DEVICE="${{ matrix.device }}"
        
        # å¸¸è§è®¾å¤‡æ¶æ„æ˜ å°„
        if [[ "$DEVICE" == *"xiaomi"* ]]; then
          TARGET="ramips/mt7621"
        elif [[ "$DEVICE" == *"netgear"* ]]; then
          TARGET="ipq806x/generic"
        elif [[ "$DEVICE" == *"glinet_gl-mt3000"* ]]; then
          TARGET="mediatek/filogic"
        elif [[ "$DEVICE" == *"linksys"* ]]; then
          TARGET="mvebu/cortexa9"
        elif [[ "$DEVICE" == *"tplink"* ]]; then
          TARGET="ath79/generic"
        else
          echo "::error::Unknown device type: $DEVICE"
          exit 1
        fi
        
        echo "target=$TARGET" >> $GITHUB_OUTPUT
        echo "sanitized_target=${TARGET//\//-}" >> $GITHUB_OUTPUT
        echo "::notice::Target for $DEVICE: $TARGET"

    - name: â¬‡ï¸ Download ImageBuilder
      run: |
        SANITIZED_TARGET="${{ steps.target.outputs.sanitized_target }}"
        IB_URL="https://downloads.immortalwrt.org/releases/${{ matrix.version }}/targets/${{ steps.target.outputs.target }}/immortalwrt-imagebuilder-${{ matrix.version }}-$SANITIZED_TARGET.Linux-x86_64.tar.xz"
        
        echo "ğŸ“¥ Downloading ImageBuilder from: $IB_URL"
        if ! wget -q --spider "$IB_URL"; then
          echo "::error::ImageBuilder not found at $IB_URL"
          exit 1
        fi
        
        wget -O imagebuilder.tar.xz "$IB_URL"
        tar -xJf imagebuilder.tar.xz
        mv immortalwrt-imagebuilder-* imagebuilder
        echo "âœ… ImageBuilder extracted successfully"

    - name: ğŸ“¦ Prepare Packages
      id: packages
      run: |
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰åŒ…åˆ—è¡¨
        CUSTOM_PKG_FILE="config/packages_${{ matrix.device }}.txt"
        DEFAULT_PKG_FILE="config/default_packages.txt"
        
        if [ -f "$CUSTOM_PKG_FILE" ]; then
          echo "::notice::Using custom packages for ${{ matrix.device}}"
          PACKAGES=$(tr '\n' ' ' < "$CUSTOM_PKG_FILE")
        elif [ -f "$DEFAULT_PKG_FILE" ]; then
          echo "::notice::Using default packages"
          PACKAGES=$(tr '\n' ' ' < "$DEFAULT_PKG_FILE")
        else
          echo "::error::No package list found!"
          exit 1
        fi
        
        # æ·»åŠ å¿…è¦çš„åŸºç¡€åŒ…
        BASE_PKGS="luci luci-theme-bootstrap -dnsmasq dnsmasq-full"
        FULL_PKGS="$BASE_PKGS $PACKAGES"
        
        echo "ğŸ“¦ Packages to install: $FULL_PKGS"
        echo "PACKAGES=$FULL_PKGS" >> $GITHUB_ENV

    - name: ğŸ”¨ Build Firmware
      run: |
        cd imagebuilder
        echo "ğŸš€ Building firmware for ${{ matrix.device }} with packages: $PACKAGES"
        
        # æ˜¾ç¤ºå¯ç”¨é…ç½®
        make info
        
        if ! make image PROFILE="${{ matrix.device }}" PACKAGES="$PACKAGES" FILES="../files/"; then
          echo "::error::Build failed for ${{ matrix.device }}"
          exit 1
        fi
        
        echo "âœ… Build completed successfully"

    - name: ğŸ—œï¸ Archive Artifacts
      run: |
        mkdir -p ../artifacts/${{ matrix.device }}
        cp bin/targets/*/*/*.bin ../artifacts/${{ matrix.device }}/
        echo "DEVICE=${{ matrix.device }}" >> $GITHUB_ENV
        echo "ARTIFACT_DIR=artifacts/${{ matrix.device }}" >> $GITHUB_ENV
        echo "::notice::Artifacts stored in artifacts/${{ matrix.device }}"

    - name: ğŸš€ Upload Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.ARTIFACT_DIR }}/*.bin
        tag_name: build-${{ github.run_id }}-${{ matrix.device }}
        name: "Build ${{ github.run_number }} (${{ matrix.device }})"
        body: |
          ### ğŸš€ ImmortalWrt Firmware Build
          **Device**: ${{ matrix.device }}
          **Version**: ${{ matrix.version }}
          **Build ID**: ${{ github.run_id }}
          **Build Date**: ${{ steps.date.outputs.date }}

          ğŸ”§ Built with GitHub Actions
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
