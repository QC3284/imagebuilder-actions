name: ğŸ”§ ImmortalWrt AutoBuilder

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCåˆå¤œè‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-firmware:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include: ${{ fromJson(needs.config.outputs.matrix) }}

    steps:
    - name: ğŸ›¬ Checkout Repository
      uses: actions/checkout@v4

    - name: âš™ï¸ Load Configuration
      id: config
      run: |
        # è¯»å–é…ç½®æ–‡ä»¶
        DEVICES=$(jq -r '.devices[]' config/devices.json)
        VERSION=$(jq -r '.version' config/version.json)
        
        # ç”Ÿæˆæ„å»ºçŸ©é˜µ
        MATRIX=$(jq -n '{include: []}')
        for DEVICE in $DEVICES; do
          MATRIX=$(echo $MATRIX | jq \
            --arg device "$DEVICE" \
            --arg version "$VERSION" \
            '.include += [{
              device: $device,
              version: $version
            }]')
        done
        
        echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ”§ Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libncurses5-dev zlib1g-dev \
          gawk git gettext libssl-dev xsltproc wget unzip python3

    - name: â¬‡ï¸ Download ImageBuilder
      run: |
        IB_URL="https://downloads.immortalwrt.org/releases/${{ matrix.version }}/targets/${{ matrix.target }}/immortalwrt-imagebuilder-${{ matrix.version }}-${{ matrix.target }}.Linux-x86_64.tar.xz"
        wget -O imagebuilder.tar.xz "$IB_URL"
        tar -xJf imagebuilder.tar.xz
        mv immortalwrt-imagebuilder-* imagebuilder

    - name: ğŸ“¦ Prepare Packages
      id: packages
      run: |
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰åŒ…åˆ—è¡¨
        if [ -f "config/packages_${{ matrix.device }}.txt" ]; then
          echo "Using custom packages for ${{ matrix.device}}"
          PACKAGES=$(tr '\n' ' ' < "config/packages_${{ matrix.device }}.txt")
        else
          echo "Using default packages"
          PACKAGES=$(tr '\n' ' ' < "config/default_packages.txt")
        fi
        echo "PACKAGES=$PACKAGES" >> $GITHUB_ENV

    - name: ğŸ”¨ Build Firmware
      run: |
        cd imagebuilder
        make image PROFILE="${{ matrix.device }}" \
          PACKAGES="$PACKAGES" \
          FILES="../files/"  # å¯é€‰çš„å®šåˆ¶æ–‡ä»¶ç›®å½•

    - name: ğŸ—œï¸ Archive Artifacts
      run: |
        mkdir -p artifacts/${{ matrix.device }}
        cp imagebuilder/bin/targets/*/*/*.bin artifacts/${{ matrix.device }}/
        echo "DEVICE=${{ matrix.device }}" >> $GITHUB_ENV

    - name: ğŸš€ Upload Release
      uses: softprops/action-gh-release@v1
      with:
        files: artifacts/${{ env.DEVICE }}/*.bin
        tag_name: build-${{ github.run_id }}-${{ env.DEVICE }}
        name: "Build ${{ github.run_id }} (${{ env.DEVICE }})"
        body: "ImmortalWrt ${{ matrix.version }} for ${{ env.DEVICE }}"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
