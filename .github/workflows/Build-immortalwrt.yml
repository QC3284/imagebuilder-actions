name: ðŸ”§ ImmortalWrt AutoBuilder

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'config/*'

jobs:
  config:
    name: âš™ï¸ Load Configuration
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: ðŸ›¬ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ” Validate Config Files
      run: |
        if [ ! -f "config/devices.json" ] || [ ! -f "config/version.json" ]; then
          echo "::error::Missing config files!"
          exit 1
        fi
        echo "Config files validation passed âœ…"

    - name: ðŸ“‹ Read Configuration
      id: set-matrix
      run: |
        if jq -e '.devices' config/devices.json >/dev/null 2>&1; then
          DEVICES=$(jq -r '.devices[]' config/devices.json)
        else
          DEVICES=$(jq -r '.[]' config/devices.json)
        fi
        
        VERSION=$(jq -r '.version' config/version.json)
        
        MATRIX_JSON=$(jq -n -c \
          --argjson devices "$(jq -n -c --arg in "$DEVICES" '$in | split("\n") | map(select(. != ""))')" \
          --arg version "$VERSION" \
          '{
            include: $devices | map({
              device: .,
              version: $version
            })
          }')
        
        echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
        echo "::notice::Build matrix generated for $VERSION: $MATRIX_JSON"

  build-firmware:
    name: ðŸ”¨ Build ${{ matrix.device }}
    needs: config
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.config.outputs.matrix) }}
      fail-fast: false

    steps:
    - name: ðŸ›¬ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ“… Get Build Date
      id: get-date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    - name: ðŸ”§ Setup Build Environment
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential libncurses5-dev zlib1g-dev \
          gawk git gettext libssl-dev xsltproc wget unzip python3 jq zstd

    - name: ðŸ—ºï¸ Determine Target Architecture
      id: target
      run: |
        DEVICE="${{ matrix.device }}"
        
        declare -A DEVICE_TARGETS=(
          ["glinet_gl-mt3000"]="mediatek/filogic"
          ["glinet_gl-mt6000"]="mediatek/filogic"
          ["xiaomi_redmi-router-ax6000"]="mediatek/filogic"
          ["xiaomi_mi-router-3g"]="ramips/mt7621"
          ["netgear_r7800"]="ipq806x/generic"
          ["linksys_wrt3200acm"]="mvebu/cortexa9"
          ["tplink_archer-c7-v5"]="ath79/generic"
        )
        
        if [[ -n "${DEVICE_TARGETS[$DEVICE]}" ]]; then
          TARGET="${DEVICE_TARGETS[$DEVICE]}"
        else
          echo "::error::Unknown device type: $DEVICE"
          exit 1
        fi
        
        echo "target=$TARGET" >> $GITHUB_OUTPUT
        echo "sanitized_target=${TARGET//\//-}" >> $GITHUB_OUTPUT
        echo "::notice::Target for $DEVICE: $TARGET"

    - name: â¬‡ï¸ Download ImageBuilder
      run: |
        SANITIZED_TARGET="${{ steps.target.outputs.sanitized_target }}"
        VERSION="${{ matrix.version }}"
        
        BASE_URL="https://downloads.immortalwrt.org/releases/$VERSION/targets/${{ steps.target.outputs.target }}"
        
        URLS=(
          "$BASE_URL/immortalwrt-imagebuilder-$VERSION-$SANITIZED_TARGET.Linux-x86_64.tar.zst"
          "$BASE_URL/immortalwrt-imagebuilder-$SANITIZED_TARGET.Linux-x86_64.tar.zst"
          "$BASE_URL/immortalwrt-imagebuilder-$VERSION-$SANITIZED_TARGET.Linux-x86_64.tar.xz"
          "$BASE_URL/immortalwrt-imagebuilder-$SANITIZED_TARGET.Linux-x86_64.tar.xz"
        )
        
        FOUND=0
        for URL in "${URLS[@]}"; do
          echo "ðŸ” Checking: $URL"
          if wget -q --spider "$URL"; then
            echo "âœ… Found valid ImageBuilder at: $URL"
            wget -O imagebuilder.tar.zst "$URL"
            FOUND=1
            break
          fi
        done
        
        if [ "$FOUND" -eq 0 ]; then
          echo "::error::ImageBuilder not found at any URL"
          for URL in "${URLS[@]}"; do
            echo "::error::Tried: $URL"
          done
          exit 1
        fi

    - name: ðŸ“¦ Extract ImageBuilder
      run: |
        if file imagebuilder.tar.zst | grep -q "Zstandard"; then
          echo "ðŸ”§ Extracting Zstandard archive"
          tar -I zstd -xf imagebuilder.tar.zst
        elif file imagebuilder.tar.zst | grep -q "XZ"; then
          echo "ðŸ”§ Extracting XZ archive"
          tar -xJf imagebuilder.tar.zst
        else
          echo "::error::Unknown archive format"
          exit 1
        fi
        
        mv immortalwrt-imagebuilder-* imagebuilder
        echo "âœ… ImageBuilder extracted successfully"

    - name: ðŸ“¦ Prepare Packages
      id: packages
      run: |
        CUSTOM_PKG_FILE="config/packages_${{ matrix.device }}.txt"
        DEFAULT_PKG_FILE="config/default_packages.txt"
        
        if [ -f "$CUSTOM_PKG_FILE" ]; then
          echo "::notice::Using custom packages for ${{ matrix.device}}"
          # è¿‡æ»¤æŽ‰ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
          PACKAGES=$(grep -vE '^#|^$' "$CUSTOM_PKG_FILE" | tr '\n' ' ')
        elif [ -f "$DEFAULT_PKG_FILE" ]; then
          echo "::notice::Using default packages"
          PACKAGES=$(grep -vE '^#|^$' "$DEFAULT_PKG_FILE" | tr '\n' ' ')
        else
          echo "::error::No package list found!"
          exit 1
        fi
        
        # æ·»åŠ å¿…è¦çš„åŸºç¡€åŒ…
        BASE_PKGS="luci luci-theme-bootstrap -dnsmasq dnsmasq-full"
        FULL_PKGS="$BASE_PKGS $PACKAGES"
        
        echo "ðŸ“¦ Packages to install: $FULL_PKGS"
        echo "PACKAGES=$FULL_PKGS" >> $GITHUB_ENV

    - name: ðŸ” Validate Packages
      run: |
        cd imagebuilder
        echo "ðŸ” Validating packages using package list..."
        
        # èŽ·å–å¯ç”¨åŒ…åˆ—è¡¨ï¼ˆæ–°æ–¹æ³•ï¼‰
        if [ -f "repositories.conf" ]; then
          echo "ðŸ“‹ Using repositories.conf for package list"
          # ä»Žæ‰€æœ‰æºèŽ·å–åŒ…åˆ—è¡¨
          AVAILABLE_PACKAGES=$(find . -name Packages | xargs cat | grep -E "^Package: " | awk '{print $2}' | sort -u)
        elif [ -f "packages/Packages.manifest" ]; then
          echo "ðŸ“‹ Using Packages.manifest for package list"
          AVAILABLE_PACKAGES=$(awk '{print $1}' packages/Packages.manifest | sort -u)
        else
          echo "::warning::No package list found, skipping validation"
          exit 0
        fi
        
        # æ£€æŸ¥æ¯ä¸ªåŒ…æ˜¯å¦å¯ç”¨
        for PKG in $PACKAGES; do
          # è·³è¿‡æŽ’é™¤çš„åŒ…ï¼ˆä»¥-å¼€å¤´ï¼‰
          if [[ $PKG == -* ]]; then
            continue
          fi
          
          if ! echo "$AVAILABLE_PACKAGES" | grep -q -w "$PKG"; then
            echo "::error::Package $PKG is not available in this ImageBuilder"
            echo "::error::Available packages: $(echo "$AVAILABLE_PACKAGES" | head -n 5 | tr '\n' ' ')..."
            exit 1
          else
            echo "âœ… Package $PKG is available"
          fi
        done
        
        echo "ðŸŽ‰ All packages are valid"

    - name: ðŸ”¨ Build Firmware
      run: |
        cd imagebuilder
        echo "ðŸš€ Building firmware for ${{ matrix.device }} with packages: $PACKAGES"
        
        # æ˜¾ç¤ºå¯ç”¨é…ç½®
        if [ -f "Makefile" ]; then
          make info || true
        fi
        
        # å¢žåŠ æž„å»ºè¯¦ç»†æ—¥å¿—
        if ! make image PROFILE="${{ matrix.device }}" PACKAGES="$PACKAGES" FILES="../files/" V=s; then
          echo "::error::Build failed for ${{ matrix.device }}"
          
          # æ”¶é›†é”™è¯¯æ—¥å¿—
          if [ -d "logs" ]; then
            ERRORS=$(grep -i 'error\|failed\|undefined' logs/*.log | head -n 20 || true)
          else
            ERRORS="No logs directory found"
          fi
          
          echo "::error::Build errors:"
          echo "$ERRORS"
          
          exit 1
        fi
        
        echo "âœ… Build completed successfully"

    - name: ðŸ—œï¸ Archive Artifacts
      run: |
        mkdir -p ../artifacts/${{ matrix.device }}
        cp bin/targets/*/*/*.bin ../artifacts/${{ matrix.device }}/
        echo "DEVICE=${{ matrix.device }}" >> $GITHUB_ENV
        echo "ARTIFACT_DIR=artifacts/${{ matrix.device }}" >> $GITHUB_ENV
        echo "::notice::Artifacts stored in artifacts/${{ matrix.device }}"

    - name: ðŸš€ Upload Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.ARTIFACT_DIR }}/*.bin
        tag_name: build-${{ github.run_id }}-${{ matrix.device }}
        name: "Build ${{ github.run_number }} (${{ matrix.device }})"
        body: |
          ### ðŸš€ ImmortalWrt Firmware Build
          **Device**: ${{ matrix.device }}
          **Version**: ${{ matrix.version }}
          **Build ID**: ${{ github.run_id }}
          **Build Date**: ${{ steps.get-date.outputs.date }}

          ðŸ”§ Built with GitHub Actions
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
